function [ elastixPoints ] = readElastixPoints(filename)
% READELASTIXPOINTS Read transform parameters generated by Elastix in text files.
% Author: Paul Balança
%
% [ elastixPoints ] = READELASTIXPOINTS(filename)
%
%     Input:
%        filename            Filename where to read transform points by Transformix.
%
%     Output:
%        elastixPoints       Struct containing index (in the fixed volume) and points (in mm).
%

% Open text file
filePoints = fopen(filename, 'rt');
if filePoints == -1
    error('Could not open file "%s".\n', filename);
end

% Read lines
elastixPoints = struct;
no = 1;
while ~feof(filePoints)
    % Read line
    line = fgetl(filePoints);
    
    % Read index values
    matchVal = regexp(line, 'OutputIndexFixed = \[(?<values>[^\]]*)', 'names');
    values = str2num(matchVal.values); %#ok<ST2NM>
    if numel(values) == 2
        elastixPoints.index(no, 1:2) = values + 1;
    else
        elastixPoints.index(no, 1:3) = values + 1;
    end
    
    % Read points values
    matchVal = regexp(line, 'OutputPoint = \[(?<values>[^\]]*)', 'names');
    values = str2num(matchVal.values); %#ok<ST2NM>
    if numel(values) == 2
        elastixPoints.point(no, 1:2) = values;
    else
        elastixPoints.point(no, 1:3) = values;
    end

    % Read deformation
    matchVal = regexp(line, 'Deformation = \[(?<values>[^\]]*)', 'names');
    values = str2num(matchVal.values); %#ok<ST2NM>
    if numel(values) == 2
        elastixPoints.deformation(no, 1:2) = values;
    else
        elastixPoints.deformation(no, 1:3) = values;
    end
    
    no = no + 1;
end
fclose(filePoints);

end
